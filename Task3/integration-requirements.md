# Требования к внешним интеграциям - Сервисы "Умный дом"

## Обзор интеграции

PropDevelopment интегрируется с внешней платформой партнера для предоставления сервисов "Умный дом" собственникам недвижимости. Интеграция включает два основных устройства:
- Интеллектуальный домофон с биометрическим распознаванием
- Интеллектуальный шлагбаум с распознаванием номерных знаков

## 1. Требования к безопасности

### 1.1 Шифрование данных
- **Обязательно**: Все данные передаются по протоколу TLS 1.3
- **Обязательно**: Биометрические данные шифруются дополнительно с использованием AES-256
- **Обязательно**: Номера автомобилей хэшируются перед передачей
- **Обязательно**: Видеопоток с домофона шифруется end-to-end

### 1.2 Аутентификация и авторизация
- **Обязательно**: Взаимная TLS аутентификация (mTLS) между системами
- **Обязательно**: Использование OAuth 2.0 с JWT токенами для API доступа
- **Обязательно**: Токены имеют срок действия не более 1 часа
- **Обязательно**: Реализация refresh token механизма
- **Обязательно**: Роль-ориентированный доступ (RBAC) для управления устройствами

### 1.3 Защита персональных данных
- **Обязательно**: Соответствие требованиям 152-ФЗ "О персональных данных"
- **Обязательно**: Минимизация сбора данных - только необходимые биометрические данные
- **Обязательно**: Автоматическое удаление биометрических данных через 30 дней неактивности
- **Обязательно**: Логирование всех операций с персональными данными
- **Обязательно**: Возможность полного удаления данных по запросу пользователя

### 1.4 Сетевая безопасность
- **Обязательно**: Использование VPN туннеля для связи с устройствами
- **Обязательно**: Firewall правила для ограничения доступа только к необходимым портам
- **Обязательно**: Регулярное обновление сертификатов безопасности
- **Обязательно**: Мониторинг сетевого трафика на предмет аномалий

## 2. Протоколы аутентификации и авторизации

### 2.1 Аутентификация системы
```
Протокол: OAuth 2.0 + mTLS
Алгоритм: RS256 (RSA с SHA-256)
Формат токена: JWT
Структура claims:
{
  "iss": "propdevelopment.com",
  "sub": "system_id",
  "aud": "smart-home-partner.com",
  "exp": 1735689600,
  "iat": 1735686000,
  "scope": "device:control device:read",
  "client_id": "propdev_smart_home"
}
```

### 2.2 Аутентификация пользователей
```
Протокол: OAuth 2.0 Authorization Code Flow
Алгоритм: ES256 (ECDSA с SHA-256)
Формат токена: JWT
Структура claims:
{
  "iss": "propdevelopment.com",
  "sub": "user_id",
  "aud": "smart-home-api",
  "exp": 1735689600,
  "iat": 1735686000,
  "scope": "intercom:control barrier:control",
  "property_id": "property_123",
  "user_role": "owner"
}
```

### 2.3 Управление сессиями
- **Обязательно**: Сессии пользователей автоматически завершаются через 8 часов неактивности
- **Обязательно**: Возможность принудительного завершения всех сессий пользователя
- **Обязательно**: Уведомления о новых входах в систему
- **Обязательно**: Двухфакторная аутентификация для административных функций

## 3. Организация взаимодействия между системами

### 3.1 Архитектура интеграции
```
PropDevelopment Smart Home Service
    ↓ (HTTPS/REST + mTLS)
API Gateway (Kong/Nginx)
    ↓ (HTTPS/REST + OAuth 2.0)
Партнер - Умный дом Platform
    ↓ (MQTT/HTTPS + VPN)
IoT Устройства (Домофон/Шлагбаум)
```

### 3.2 API Endpoints

#### 3.2.1 Управление домофоном
```
POST /api/v1/intercom/unlock
PUT /api/v1/intercom/access-list
GET /api/v1/intercom/logs
POST /api/v1/intercom/biometric-enroll
DELETE /api/v1/intercom/biometric/{biometric_id}
```

#### 3.2.2 Управление шлагбаумом
```
POST /api/v1/barrier/open
PUT /api/v1/barrier/vehicle-list
GET /api/v1/barrier/logs
POST /api/v1/barrier/vehicle-register
DELETE /api/v1/barrier/vehicle/{vehicle_id}
```

#### 3.2.3 Мониторинг устройств
```
GET /api/v1/devices/status
GET /api/v1/devices/health
POST /api/v1/devices/restart
GET /api/v1/devices/metrics
```

### 3.3 Форматы данных

#### 3.3.1 Запрос на открытие домофона
```json
{
  "device_id": "intercom_001",
  "user_id": "user_123",
  "property_id": "property_456",
  "action": "unlock",
  "timestamp": "2025-01-15T10:30:00Z",
  "reason": "guest_access",
  "guest_name": "Иван Иванов"
}
```

#### 3.3.2 Ответ системы
```json
{
  "request_id": "req_789",
  "status": "success",
  "device_id": "intercom_001",
  "action": "unlock",
  "timestamp": "2025-01-15T10:30:01Z",
  "execution_time_ms": 150
}
```

#### 3.3.3 Регистрация биометрических данных
```json
{
  "user_id": "user_123",
  "property_id": "property_456",
  "biometric_type": "face",
  "biometric_data": "encrypted_biometric_hash",
  "expires_at": "2025-12-31T23:59:59Z",
  "permissions": ["unlock", "video_access"]
}
```

### 3.4 Обработка ошибок
```json
{
  "error": {
    "code": "DEVICE_UNAVAILABLE",
    "message": "Устройство временно недоступно",
    "details": {
      "device_id": "intercom_001",
      "last_seen": "2025-01-15T10:25:00Z",
      "retry_after": 30
    }
  }
}
```

### 3.5 Webhook уведомления
```
Endpoint: POST /webhooks/device-events
Authentication: HMAC-SHA256 signature
Content-Type: application/json

{
  "event_type": "access_granted",
  "device_id": "intercom_001",
  "user_id": "user_123",
  "timestamp": "2025-01-15T10:30:00Z",
  "metadata": {
    "access_method": "biometric",
    "confidence_score": 0.95
  }
}
```

## 4. Требования к производительности

### 4.1 Время отклика
- **Обязательно**: API запросы обрабатываются за время не более 2 секунд
- **Обязательно**: Команды управления устройствами выполняются за время не более 5 секунд
- **Обязательно**: Видеопоток с домофона имеет задержку не более 1 секунды

### 4.2 Доступность
- **Обязательно**: Доступность системы 99.9% (не более 8.77 часов простоя в год)
- **Обязательно**: Автоматическое переключение на резервные серверы при сбоях
- **Обязательно**: Мониторинг состояния всех компонентов в реальном времени

### 4.3 Масштабируемость
- **Обязательно**: Поддержка до 10,000 одновременных подключений
- **Обязательно**: Возможность горизонтального масштабирования
- **Обязательно**: Автоматическое масштабирование при высокой нагрузке

## 5. Мониторинг и логирование

### 5.1 Логирование
- **Обязательно**: Логирование всех API запросов и ответов
- **Обязательно**: Логирование всех операций с устройствами
- **Обязательно**: Логирование доступа к персональным данным
- **Обязательно**: Централизованное хранение логов с ротацией

### 5.2 Мониторинг
- **Обязательно**: Мониторинг доступности всех устройств
- **Обязательно**: Мониторинг производительности API
- **Обязательно**: Мониторинг использования ресурсов
- **Обязательно**: Алерты при превышении пороговых значений

### 5.3 Метрики
```
- Количество успешных/неуспешных запросов
- Время отклика API
- Количество активных устройств
- Количество пользователей онлайн
- Использование биометрических данных
- Количество попыток несанкционированного доступа
```

## 6. Резервное копирование и восстановление

### 6.1 Резервное копирование
- **Обязательно**: Ежедневное резервное копирование конфигураций устройств
- **Обязательно**: Еженедельное резервное копирование биометрических данных
- **Обязательно**: Хранение резервных копий в зашифрованном виде
- **Обязательно**: Тестирование восстановления из резервных копий

### 6.2 План восстановления
- **Обязательно**: Время восстановления (RTO) не более 4 часов
- **Обязательно**: Максимальная потеря данных (RPO) не более 1 часа
- **Обязательно**: Документированные процедуры восстановления
- **Обязательно**: Регулярные учения по восстановлению

## 7. Соответствие стандартам

### 7.1 Нормативные требования
- **Обязательно**: Соответствие 152-ФЗ "О персональных данных"
- **Обязательно**: Соответствие ГОСТ Р 57580.1-2017 "Безопасность финансовых операций"
- **Обязательно**: Соответствие ISO/IEC 27001:2013
- **Обязательно**: Соответствие PCI DSS (если обрабатываются платежные данные)

### 7.2 Технические стандарты
- **Обязательно**: Соответствие RFC 6749 (OAuth 2.0)
- **Обязательно**: Соответствие RFC 7519 (JWT)
- **Обязательно**: Соответствие RFC 5246 (TLS 1.2+)
- **Обязательно**: Соответствие RFC 8446 (TLS 1.3)

## 8. Тестирование интеграции

### 8.1 Типы тестирования
- **Обязательно**: Unit тестирование всех API endpoints
- **Обязательно**: Интеграционное тестирование с реальными устройствами
- **Обязательно**: Нагрузочное тестирование
- **Обязательно**: Тестирование безопасности (penetration testing)

### 8.2 Тестовые сценарии
```
1. Успешное открытие домофона по биометрии
2. Отказ в доступе при низком качестве биометрии
3. Открытие шлагбаума по распознаванию номера
4. Обработка ошибок при недоступности устройства
5. Масштабирование при высокой нагрузке
6. Восстановление после сбоев
```

## 9. Документация и обучение

### 9.1 Техническая документация
- **Обязательно**: API документация с примерами запросов
- **Обязательно**: Схемы архитектуры системы
- **Обязательно**: Руководство по развертыванию
- **Обязательно**: Руководство по устранению неполадок

### 9.2 Обучение персонала
- **Обязательно**: Обучение администраторов системы
- **Обязательно**: Обучение службы поддержки
- **Обязательно**: Регулярное обновление знаний
- **Обязательно**: Сертификация специалистов

## 10. Соглашения об уровне сервиса (SLA)

### 10.1 Гарантии доступности
- **Обязательно**: 99.9% доступность в рабочее время (8:00-22:00)
- **Обязательно**: 99.5% доступность в нерабочее время
- **Обязательно**: Уведомление о плановых работах за 48 часов

### 10.2 Время реакции на инциденты
- **Обязательно**: Критические инциденты - 15 минут
- **Обязательно**: Высокий приоритет - 1 час
- **Обязательно**: Средний приоритет - 4 часа
- **Обязательно**: Низкий приоритет - 24 часа

### 10.3 Штрафные санкции
- **Обязательно**: Компенсация за превышение времени простоя
- **Обязательно**: Компенсация за потерю данных
- **Обязательно**: Компенсация за нарушение SLA